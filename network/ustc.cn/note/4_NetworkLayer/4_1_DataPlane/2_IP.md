## IP
> IP(Internet Protocol)

### IP数据包
```P4
header ipv4_t {
    bit<4>   version; //版本号
    bit<4>   ihl; //ip header length
    bit<6>   dscp; //区分服务，指定数据包的优先级、服务质量（QoS）和流量分类
    bit<2>   ecn;
    bit<16>  total_len; //数据包长度
    bit<16>  identification; //每个IP数据包进行唯一标识，用于重组分片
    bit<3>   flags; //指示数据包分片和重组的状态
    bit<13>  frag_offset; //指示数据包分片后的相对位置
    bit<8>   ttl;
    bit<8>   protocol; //：指示IP数据包所携带的上层协议，如TCP、UDP或ICMP
    bit<16>  hdr_checksum;
    bit<32>  src_addr;
    bit<32>  dst_addr;
}
```

### IP分片&重组
> 上述数据包中`identification`，`flags`和`frag_offset`均与IP分片&重组有关系

原因：网络链路有MTU（最大传输单元），与链路层有关，不同链路类型对应不同的MTU，故大的IP报文在链路中被分片（fragmented）

同一数据包在传输时被分成不同的片，这些片具有相同的`identification`，不同的`frag_offset`，最后一个分片的`flags`为0。重组只在最终的目标主机上进行。

### IPV4地址
> IP地址，32位，对主机和路由器的接口（主机/路由器和物理链路的连接处）进行编址，一个接口对应一个IP

子网：IP地址分为两部分：主机地址（低位bits）+子网地址（高位bits），一个子网内的节点（主机或路由器）其高位（子网）部分相同，这些节点构成的网络叫做子网。

子网的特点：无需路由器的介入，子网内各主机物理上互联。

IP分类：
1. A：最高为0,范围：1.0.0.0 到 126.0.0.0，第一个8位标识网络，后24位标识主机，A类地址支持大量的主机，因此适用于大型网络。
2. B：前两位为10,范围：128.0.0.0 到 191.255.0.0。前两个8位标识网络，后16位用于主机标识。B类地址支持中等规模的网络。
3. C：前三位为110，范围：192.0.0.0 到 223.255.255.0。前三个8位标识网络，后8位用于主机标识。C类地址适用于小型网络，由于可用的主机地址较少，其主要用于较小的组织或企业。
4. D：前四位为1110的地址，用于`多播（Multicast）通信`。它的范围是224.0.0.0 到 239.255.255.255。D类地址用于将数据包发送给多个接收者，用于多播组的通信。
5. E：前四位为1111的地址，`保留为将来使用`。它的范围是240.0.0.0 到 255.255.255.255，目前尚未被分配使用。

特殊的IP地址：
1. 子网部分全为0：本网络
2. 主机部分全为0：本主机
3. 主机部分全为1：当前子网下的广播地址

内网专用IP：
1. Class A 10.0.0.0-10.255.255.255 MASK 255.0.0.0
2. Class B 172.16.0.0-172.31.255.255 MASK 255.255.0.0
3. Class C 192.168.0.0-192.168.255.255 MASK 255.255.255.0

其特点：
1. 永远不会被当作公用地址，只在局域网内有意义（用于区分不同的设备）
2. 路由器不对目标地址是专用地址的分组进行转发（因为只对当前子网有意义，故不会转发到其他网段）

除了上述将IP地址划分为不同种类，还有一种IP编址方式：CIDR（无类域间路由）
1. 子网部分可以是任意位置
2. 网络地址形式为`a.b.c.d/x`，其中X是地址中子网号的长度

子网掩码就是上述X的另一种表现形式，32bit，由0和1构成，其中1表示IP地址中的网络部分。0代表主机部分。

层次编制：将IP地址空间划分为多个层次结构，以便更有效地进行路由和地址管理。分类网络和CIDR均是其实现方式。

路由聚合：将多个具有相同前缀的网络地址合并为一个较大的地址块，以简化路由表和提高路由的效率。（CIDR进入的概念。）

### NAT
> NAT(Network Address Translation)

动机：IPV4地址不足，NAT可以在私有网络和公有网络中进行地址转换，使得私有网络的主机可以通过一个公用的IP地址访问互联网。

NAT的实现方式：
1. 子网的网关路由器会维护一张NAT转换表（表项是[私有地址IP,端口号]:[NAT IP,新端口号]）
2. 从子网发出的数据包会替换源IP和端口号为NAT IP（通常就是子网的网关IP）和新端口号
3. 进入子网的数据包会替换NAT IP和新端口号为私有地址IP,端口号

问题：NAT穿越（客户端想要主动连接子网中的服务器，如何操作？？  P2P应用等需要考虑）

### IPV6

初始动机：IPV4地址很快就会被耗尽，其他动机：头部格式改进帮助快速处理（移除了checksum）和转发，实现QOS

```P4
header ipv6_t {
    bit<4>    version;
    bit<8>    traffic_class; //优先级
    bit<20>   flow_label; //标识数据包在一个FLOW（FLOW的概念不明确）
    bit<16>   payload_len;
    bit<8>    next_hdr; //上层协议
    bit<8>    hop_limit;
    bit<128>  src_addr;
    bit<128>  dst_addr;
}
```

IPV4迁移至IPV6,过程缓慢，目前使用隧道技术支持IPV6,简单来讲就是在支持IPV6协议的路由器之间传递IPV6数据包，在仅支持IPV4协议的路由器上把IPV6数据包作为Payload封装成IPV4数据包进行传播即可。
